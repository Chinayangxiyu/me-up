# 一、zk基础

## 1.1 概述
zk是一个分布式协调服务，为分布式应用程序提供协调/通知、集群管理、master选举、发布/订阅、  
分布式锁等功能。具有高性能、高可用、严格顺序写的特性。  
高性能：基于内存的存储保障了高性能。  
高可用：集群中超过一半的节点正常，就能提供服务。  
严格顺序性：每个请求都会按照顺序生成事务ID，并按顺序去处理事务。

## 1.2 基本概念

### 集群：
集群节点分Leader、Follower、Observer；Leader提供读写服务，Follower、Observer都能提供读服务，但Observer不参与选举。

### 会话：
客户端启动时会创建一个与服务器的TCP长连接，用来进行心跳检测、发生请求、接收服务器的Watch事件通知。客户端断开连接后，如果
能在规定的时间内重连，那么之前的会话依然有效。

### 数据节点
zk的数据单元称为数据节点（ZNode），数据模型是Tree；每个Znode保存自己的数据类容和属性。  
ZNode分持久化节点、临时节点。持久化节点需要主动移除；临时节点和客户端会话绑定，若会话失效则临时节点被移除。

顺序节点：每个父节点都会为它的第一级子节点维护一份顺序，记录每个子节点创建的先后顺序。

### 版本
每个ZNode都使用stat结构记录ZNode的数据版本。

### Watcher
事件监听器，用户向指定节点注册Watcher，zookeeper服务器会在事件发生时推给客户端。

## 1.3 ZAB协议
为zookeeper设计的数据一致性算法，支持崩溃恢复的原子广播协议。  
ZAB协议的核心是定义对zookeeper写数据的事务请求的处理方式，分为消息广播和崩溃恢复模式。

### ZAB协议消息广播
（1）所有事务请求都有leader服务器处理，Follower收到写请求时会转发给leader处理；  
（2）leader将客户端请求包装成一个事务proposal（提议），并将proposal分发给Follower；  
（3）leader等待Follower的反馈，当超过半数的Follower进行了正确反馈后，leader会再向所有的Follower分发commit消息去提交proposal。

### ZAB协议崩溃恢
当leader崩溃，或leader与超过半数的Follower失去联系就会进入崩溃恢复模式；需要选举出新的leader。  
（1）ZAB协议事务编号（ZXID）是一个64位的数字，高32位表示leader选举周期的epoch编号，  
低32位表示当前epoch周期内事务的编号  
（2）选举让具有最高编号事务proposal的机器成为leader。


# 二、zk原理


# 三、zk典型应用场景

## 3.1 数据发布/订阅
使用Watcher事件通知机制实现，客户端向服务器注册自己关注的ZNode，当关注的ZNode数据发生变更后；  
服务器会向响应的客户端发生Watcher事件通知。

## 3.2 分布式锁
### 独占锁
创建锁：客户端去创建一个临时节点（lock），zookeeper保证所有客户端只有一个创建成功；  
释放锁：会话丢失或者手动移除lock，zookeeper会通知所有在对应节点上注册了"节点变更Watcher监听"的客户端。

###
定义锁：临时顺序节点表示共享锁，格式：Hostname-请求类型-序号。  
获取锁：Hostname-R-序号表示读锁，Hostname-W-序号表示写锁。  
判断读写顺序：获取读锁时，如果当前临时节点序号是最小的，或者在此之前的节点都是读锁，那么获取成功；否则失败。  
获取写锁时，当前请求创建的临时节点序号必须是最小的才能获取成功。

### 羊群效应
共享锁创建的节点很多，如果"所有"获取锁失败的客户端对"所有"锁（临时节点）都注册了数据变更的监听；  
那么在锁释放后，服务器会去通知所有的客户端，这就是"羊群效应"。

### 分布式锁优化（避免羊群效应）
大量的通知会影响Zookeeper的性能，而且很大一部分通知都不是必须的。每个获取锁的请求只需要关注特殊的节点即可。  
读锁请求：只需要向比自己序号小的最后一个写锁节点注册Watcher监听。  
写锁请求：向比自己序号小的最后一个节点注册Watcher监听。


## 3.3 Master选举
zk客户端无法重复创建一个已经存在的数据节点，客户端集群去zk创建临时节点；创建成功的客户端就是master；
如果master挂了（会话丢失，临时节点被移除），Watcher机制会通知所有的客户端再去重新竞争master。

## 3.4 命名服务：生成全局唯一ID
生成全局唯一

## 分布式协调/通知
Watcher注册和异步通知机制，使得zk可以用与分布式协调/通知。

## 集群管理
## 负载均衡
## 分布式队列
