# 分库分表的方案
1、根据业务关联性进行拆分，比如订单中心使用订单号分表、用户中心使用用户ID分表；
2、分库可以取模、分段、哈希等方案确定保存的库
3、复杂查询使用ES，使用binlog将数据同步到ES

# 分库分表后

[参考](https://www.cnblogs.com/twoheads/p/10715498.html)


## 为什么分库分表

（1）当数据库热点数据太多，缓存命中率过低，每次查询都需要IO操作导致查询效率过低；  
可以考虑分库和垂直分表，把热点数据分散开。  
（2）网络请求太多，网络带宽不够，或者超过了数据库处理请求的上限，导致效率过低，需要考虑分库。  
（3）单表数据量太大，每次扫描的行数太多，需要考虑水平分表。

总结：一般数据量大同时会带有网络请求多的问题，所以分库和水平分表较为常见。

## 分库分表的步骤
### 1、评估容量，确定分库分表的个数
阿里巴巴开发规范：单表数据超过500万行，或者容量超过2GB才考虑分表。
单表数据1000万以下时mysql状态最佳。

### 2、选择分表的key
筛选API，使用最多的共同条件可以作为sharding column，sharding column的选取保证业务强相关，比如订单系统的单号、用户系统的用户ID。

### 3、选择分表规则
按照时间进行范围切片：优点是单表可控，天然水平扩容；缺点是无法解决集中写入瓶颈。  
根据hash值取模切片：采用mod n 哈希取模数据库节点，分布均匀，但是扩容时数据全部需要重新计算哈希值，重新取模定位数据库ID。  
[一致性哈希切片](../未分类.md#七一致性哈希)：分布均匀，易于水平扩容，扩容时迁移的数据节点较少，但是数据量较大。


### 4、扩容方案
（1）升级从库
每个主库都至少配置一个从库，扩容时把从库升级为主库，并修改主库的配置信息；
此时因为"新的主库"数据和 之前同步的主库存在数据冗余，需要进行清理。
最后需要重新为每个主库配置一个从库。

（2）双写
需要扩容时（监听表内数据，达到一定量），新增新库和写连接，同时写两份数据。
同步老库数据到新库（根据哈希值判断属于哪个库），数据迁移后需要数据校验保证一致性。
最后修改分片信息。


## 分库分表需要考虑的问题

（1）非partition key查询的问题：冗余数据和映射实现非partition key的问题。
冗余数据会增加存储、维护成本；映射会增加网络开销。

（2）跨库跨表、分页等复杂查询
使用mysql的binLog将数据同步到ES，使用ES完成复杂查询。

（3）扩容问题
尽量保证已有数据迁移减少。

# 构建一个分库分表的插件，需要注意哪些方面
（1）新增、更新、查询根据key获取数据库ID，确定数据库ID后需要动态切换数据源（DynamicDataSource）
（2）查询结果集归并；
（3）分布式事务支持；
